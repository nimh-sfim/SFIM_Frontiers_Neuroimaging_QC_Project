# Notes on Figure Generation

Many of the figures are based images that were automatically created when
`afni_proc.py` was run for each subject. The followings desecriptions list
which images were used or what was done to go from the generated images
to the figured that are included in the manuscript.

## Figure 1

Generated by manually saving slices in the AFNI GUI. 
`./ap_results_unifize_masked_warper/sub-017/pb00.sub-017.r01.tcat+orig.HEAD`
was used. The I,J,K coordinates for the crosshairs are (32,32,17).
The images are from volume indices: 20, 35, 42, and 54.

 The motion and outlier time course was automatically generated by
 `afni_proc.py` and included in the html report. That figure is stored as
 `./ap_results_unifize_masked_warper/sub-017/QC_sub-017/media/qc_09_mot_enormoutlr.jpg`

Note: For all jpg images in the media directory for the html report, there is also a json file that list the source volumes used to create the image.

## Figure 2

Generated by manually saving slices in the AFNI GUI.
`./ap_results_unifize_masked_warper/sub-029/pb00.sub-029.r01.tcat+orig.HEAD`
was used. The I,J,K coordinates for the crosshairs are (32,32,17).
The images are from volume indices: 155, 166, 167, and 173.

 The motion and outlier time course was automatically generated and included
 in the html report. That figure is stored as 
 `./ap_results_unifize_masked_warper/sub-029/QC_sub-029/media/qc_09_mot_enormoutlr.jpg`

## Figure 3

Uses two images that are automatically generated as part of AFNI’s html report.

The native space unprocessed EPI in the top row is:
`/ap_results_unifize_masked_warper/sub-017/QC_sub-017/media/qc_00_vorig_EPI.axi.jpg`

The aligned EPI with the sulcal edges from the anatomical scan is:
`./ap_results_unifize_masked_warper/sub-017/QC_sub-017/media/qc_03_ve2a_epi2anat.axi.jpg`

The figure includes a mosiac of axial slices, but the report also includes
mosaics of saggital slices.

Both these images were processed in GIMP. The black background was filled with
a consistent shade of black and then the “zealous crop” option was used to
remove black space between, above, and below slices. This retained all data,
including any ghosting, while letting the brain slices be relatively large
within the same amount of space.

## Figure 4

Uses images that were automatically generated as part of AFNI’s html report.
These are similar to the second row of images in figure 3 and the same image
processing in GIMP was applied to them. The images are:

- `./ap_results_unifize_masked_warper/sub-016/QC_sub-016/media/qc_03_ve2a_epi2anat.axi.jpg`
- `./ap_results_unifize_masked_warper/sub-021/QC_sub-021/media/qc_03_ve2a_epi2anat.axi.jpg`
- `./ap_results_unifize_masked_warper/sub-022/QC_sub-022/media/qc_03_ve2a_epi2anat.axi.jpg`
- `./ap_results_unifize_masked_warper/sub-026/QC_sub-026/media/qc_03_ve2a_epi2anat.axi.jpg`
- `./ap_results_unifize_masked_warper/sub-028/QC_sub-028/media/qc_03_ve2a_epi2anat.axi.jpg`

## Figure 5

Uses an image that was automatically generated by AFNI’s @SSwarper command.
The specific file used is: `./sswarper_mask/sub-102/QC_anatQQ.sub-102.jpg`

That figure included a horizonal blue line between each row that too up an unnecessary amount of space in the final figure. Using GIMP, that line was removed, the black background was filled in a consistent change of black, and then a “zealous crop” was applied.

## Figure 6

Uses an image that was automatically generated by AFNI’s @SSwarper command.
The specific file used is: `./sswarper_mask/sub-102/QC_anatSS.sub-102.jpg`

The same image processing in GIMP from figure 5 was applied to figure 6

## Figure 7

Uses images that were automatically generated as part of AFNI’s html report.

The unflipped image is:
`./ap_results_masked_warper_rest/sub-101/QC_sub-101/media/qc_20_warns_flip_0.axi.jpg`

The flipped image is:
`./ap_results_masked_warper_rest/sub-101/QC_sub-101/media/qc_20_warns_flip_1.axi.jpg`

These were processed in GIMP as described for Figure 3.

## Figure 8

Not automatically output by AFNI. The following steps were required to create it:

```bash
# From the directory: ./Frontiers_QC_2022/Figure8_Overlap_Maps  

#### 
# For the sub-001 to sub-030 Task dataset  
# Create a summed count of the number of subjects with a voxel within a mask 
3dMean -sum -prefix sub-0xx.mask.overlap.nii.gz \
  ../ap_results_unifize_masked_warper/sub-0??/mask_epi_anat.sub-0??+tlrc.HEAD

# We use using alpha thresholding to create a contour for N=30 (voxels with all sbj in mask)
#  but then voxels with lower voxels get more translucent.
#  P Taylor suggested addressing this issue by making a threshold volume where
#  N=30 is 1 and 29>=N>=1 is 0.97
#  Then the threshold volume is used for thresholding and there's almost no decrease
#  in translucency while the summation count volume is used for coloring
3dcalc -prefix sub-0xx.mask.threshold.nii.gz \
  -a sub-0xx.mask.overlap.nii.gz \
  -expr "step(a)*(1*equals(a,30)+0.97*not(equals(a,30)))"
3dTcat -prefix sub-0xx.maskthresh.nii.gz \
  sub-0xx.mask.overlap.nii.gz sub-0xx.mask.threshold.nii.gz

# For the sub-101 to sub-120 Rest dataset
3dMean -sum -prefix sub-1xx.mask.overlap.nii.gz \
  ../ap_results_masked_warper_rest/sub-1??/mask_epi_anat.sub-1??+tlrc.HEAD
3dcalc -prefix sub-1xx.mask.threshold.nii.gz \
  -a sub-1xx.mask.overlap.nii.gz \
  -expr "step(a)*(1*equals(a,20)+0.97*not(equals(a,20)))"
3dTcat -prefix sub-1xx.maskthresh.nii.gz \
  sub-1xx.mask.overlap.nii.gz sub-1xx.mask.threshold.nii.gz



# Locate the anatomical template to use as the image underlay.  
templ_path=`@FindAfniDsetPath MNI152_2009_template_SSW.nii.gz`
underlay_dset=${templ_path}/MNI152_2009_template_SSW.nii.gz

####
# Create the image for the Task data
# The underlay is the MNI anatomical alignment template
# The overlay is colored from 1-30
# The overlay is thresholded so that there can be a countour
# line around all N=30 voxels
olay_dset=sub-0xx.maskthresh.nii.gz
@chauffeur_afni        \
  -prefix Figure8_part_TaskData_OverlapMap \
  -pbar_saveim Figure8_part_TaskData_colorbar.jpg \
  -func_range 30 \
  -ulay ${underlay_dset} \
  -olay ${olay_dset} \
  -box_focus_slices AMASK_FOCUS_OLAY \
  -cbar Plasma \
  -pbar_posonly \
  -save_ftype SAVE_ALLJPEG \
  -ulay_range 0% 98% \
  -thr_olay 0.99 \
  -olay_alpha Linear \
  -olay_boxed Yes \
  -set_subbricks 0 0 1 \
  -opacity 5  \
  -save_ftype JPEG \
  -montx 5 -monty 1 \
  -montgap 0  \
  -montcolor 'black' \
  -set_xhairs OFF \
  -label_mode 1 -label_size 4 \
  -do_clean

####
# Create the image for the Rest data
# The underlay is the MNI anatomical alignment template
# The overlay is colored from 1-20
# The overlay is thresholded so that there can be a countour
# line around all N=20 voxels
olay_dset=sub-1xx.maskthresh.nii.gz
@chauffeur_afni        \
  -prefix Figure8_part_RestData_OverlapMap \
  -pbar_saveim Figure8_part_RestData_colorbar.jpg \
  -func_range 20 \
  -ulay ${underlay_dset} \
  -olay ${olay_dset} \
  -box_focus_slices AMASK_FOCUS_OLAY \
  -cbar Plasma \
  -pbar_posonly \
  -save_ftype SAVE_ALLJPEG \
  -ulay_range 0% 98% \
  -thr_olay 0.99 \
  -olay_alpha Linear \
  -olay_boxed Yes \
  -set_subbricks 0 0 1 \
  -opacity 5  \
  -save_ftype JPEG \
  -montx 5 -monty 1 \
  -montgap 0  \
  -montcolor 'black' \
  -set_xhairs OFF \
  -label_mode 1 -label_size 4 \
  -do_clean  
```

This generates mosaics for each orientation plane. The mosiacs were zealous
cropped in GIMP, as described for figure 3.  

## Figure 9

Generated by manually saving slices in the AFNI GUI.

The EPI image for A & C is
`./ap_results_unifize_masked_warper/sub-002/pb00.sub-017.r01.tcat+orig.HEAD`.
The I,J,K coordinates for the crosshairs and the instcorr seed are (31, 23, 16).
This is also axial slice 16, sag slice 32, and cor slice 40. Instacorr was set
up with the following options:  

- Blur: 0
- Automask: yes
- Bandpass 0.01-0.1Hz.
- Despike: yes
- Image was thresholded at p<0.001 (r>0.35069) with alpha translucency for values below the threshold.

The anatomical image is
`./ap_results_unifize_masked_warper/sub-002/ anatSS.sub-002_al_junk+orig.HEAD`
(This is the anatomical that is aligned to the unprocessed EPI).
It is presented for axial slice 65, sagittal slice 97, and coronal slice 121.